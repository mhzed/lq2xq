"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const luceneQueryParser_1 = require("./luceneQuery/luceneQueryParser");
const _ = require("lodash");
const DefaultRenderOption = {
    defaultField: '.',
    termPhraseModifier: null
};
;
;
class RenderContext {
    constructor(option, hasField) {
        this.option = option;
        this.hasField = hasField;
    }
}
const renderField = (term, ctx) => {
    if (ctx.hasField) {
        let fieldname;
        if (term.field != null)
            fieldname = term.field.field;
        else
            fieldname = ctx.option.defaultField;
        return `${fieldname} contains text `;
    }
    else
        return "";
};
const convertWildCard = (term) => {
    if (/[*?]/.test(term)) {
        return term.replace(/([*])/g, ".*").replace(/[?]/g, ".");
    }
    else
        return null;
};
const renderTerm = (term, ctx) => {
    if (ctx.option.termPhraseExpander) {
        let expr = _(ctx.option.termPhraseExpander(term.term, term.field ? term.field.field : null, false))
            .map((newTerm) => renderTermClause(_.assign({}, term, { term: newTerm }), ctx))
            .join(' ftor ');
        return `(${renderField(term, ctx)}${expr})`;
    }
    else
        return `(${renderField(term, ctx)}${renderTermClause(term, ctx)})`;
};
const renderTermClause = (term, ctx) => {
    let result;
    let wildCardTerm = convertWildCard(term.term);
    if (wildCardTerm != null)
        result = `"${wildCardTerm}" using wildcards`;
    else
        result = `"${term.term}"`;
    if (term.boost != null)
        result += ` weight {${term.boost}}`;
    if (term.similarity != null) {
        if (ctx.option.similarityConverter == null)
            throw new Error("Similarity is not supported");
        else
            result += ` ${ctx.option.similarityConverter(term.similarity)}`;
    }
    if (ctx.option.termPhraseModifier)
        result += ` ${ctx.option.termPhraseModifier}`;
    return result;
};
const renderPhrase = (phrase, ctx) => {
    if (ctx.option.termPhraseExpander) {
        let expr = _(ctx.option.termPhraseExpander(phrase.term, phrase.field ? phrase.field.field : null, false))
            .map((newPhrase) => renderPhraseClause(_.assign({}, phrase, { term: newPhrase }), ctx))
            .join(' ftor ');
        return `(${renderField(phrase, ctx)}${expr})`;
    }
    else
        return `(${renderField(phrase, ctx)}${renderPhraseClause(phrase, ctx)})`;
};
const renderPhraseClause = (phrase, ctx) => {
    let result = `"${phrase.term}"`;
    if (phrase.boost != null)
        result += ` weight {${phrase.boost}}`;
    if (phrase.proximity != null)
        result += ` distance at most ${phrase.proximity} words`;
    if (ctx.option.termPhraseModifier)
        result += ` ${ctx.option.termPhraseModifier}`;
    return result;
};
const renderOperator = (op, ctx) => {
    switch (op) {
        case 'AND': return ctx.hasField ? 'AND' : 'ftand';
        case 'OR': return ctx.hasField ? 'OR' : 'ftor';
        default: throw new Error(`Operator ${op} is not recognized.`);
    }
};
const renderRange = (range, ctx) => {
    if (range.field == null)
        throw new Error("Must specify field on range query");
    let field = range.field.field;
    let ops = range.inclusive ? ['>=', '<='] : ['>', '<'];
    return `(${field}${ops[0]}"${range.term_min}" AND ${field}${ops[1]}"${range.term_max}")`;
};
const renderExpr = (expr, ctx) => {
    if (expr.operator == 'NOT') {
        throw new Error("Lucene query's NOT operator is broken, see https://stackoverflow.com/questions/17969461/" +
            "not-operator-doesnt-work-in-query-lucene, use - modifier instead");
    }
    return `(${render(expr.left, ctx)} ${renderOperator(expr.operator, ctx)} ${render(expr.right, ctx)})`;
};
const isSameField = (t1, t2) => {
    if (t1.field === t2.field)
        return true; // both null
    else if (t1.field && t2.field)
        return t1.field.field == t2.field.field;
    else
        return false;
};
const isTerm = (node) => _.has(node, "similarity");
const isPhrase = (node) => _.has(node, "proximity");
const isTermOrPhrase = (node) => isTerm(node) || isPhrase(node);
const isRange = (node) => _.has(node, 'inclusive');
const hasOperator = (node) => (true && node.operator);
const hasLeft = (node) => true && node.left;
const render = (tree, ctx) => {
    if (tree === undefined)
        return '';
    else if (isTerm(tree))
        return renderTerm(tree, ctx);
    else if (isPhrase(tree))
        return renderPhrase(tree, ctx);
    else if (isRange(tree))
        return renderRange(tree, ctx);
    else if (hasOperator(tree))
        return renderExpr(tree, ctx); // binary or unary expression
    else if (hasLeft(tree))
        return render(tree.left, ctx); // an operator-less (single term) expression
    else
        throw new Error(`${JSON.stringify(tree, null, '  ')} can't be rendered`);
};
// scan tree recursively to see if any field exists
const hasField = (tree) => {
    if (tree === undefined)
        return false;
    else
        return tree.field != null || hasField(tree.left) || hasField(tree.right);
};
const pressField = (tree) => {
    if (tree) {
        if (tree.field) {
            if (tree.left)
                tree.left.field = tree.field;
            if (tree.right)
                tree.right.field = tree.field;
        }
        if (tree.left)
            pressField(tree.left);
        if (tree.right)
            pressField(tree.right);
    }
};
const hasAnd = (tree) => {
    if (tree === undefined)
        return false;
    else
        return tree.operator === 'AND' || hasAnd(tree.left) || hasAnd(tree.right);
};
const hasPrefix = (tree) => {
    if (tree === undefined)
        return false;
    else
        return (tree.prefix) || hasPrefix(tree.left) || hasPrefix(tree.right);
};
const reconstructClauses = (tree, musts, mustnots) => {
    if (tree) {
        if (tree.prefix) {
            if (tree.prefix == '+')
                musts.push(tree);
            else if (tree.prefix == '-')
                mustnots.push(tree);
        }
        else if (isRange(tree)) {
            musts.push(tree);
        }
        reconstructClauses(tree.left, musts, mustnots);
        reconstructClauses(tree.right, musts, mustnots);
    }
};
/**
 *
 * lucene query to xquery translater
 *
 * @param {string} lq
 * @returns {string}
 *
 */
exports.lq2xq = (lq, option) => {
    let tree = luceneQueryParser_1.luceneQueryParser.parse(lq);
    if (!option)
        option = DefaultRenderOption;
    else
        option = _.assign({}, DefaultRenderOption, option); // ensure default values are filled
    let hasFieldInExr = hasField(tree);
    if (hasFieldInExr)
        pressField(tree); // ensure field is set in every Term or Phrase, instead of Expression
    let result = '';
    if (!hasFieldInExr)
        result += `${option.defaultField} contains text `;
    if (hasPrefix(tree)) {
        // if there are + or -, then we ignore all logical operators such as AND OR NOT, they are incompatible
        let pluses = [], minuses = [];
        reconstructClauses(tree, pluses, minuses);
        if (!hasFieldInExr) {
            let plusExprs = _.map(pluses, (p) => render(p, new RenderContext(option, hasFieldInExr)));
            let minusExprs = _.map(minuses, (p) => 'ftnot ' + render(p, new RenderContext(option, hasFieldInExr)));
            result += _.join(_.concat(plusExprs, minusExprs), ' ftand ');
        }
        else {
            //console.log(JSON.stringify(tree, null, '  '));
            let plusExprs = _.map(pluses, (p) => render(p, new RenderContext(option, hasFieldInExr)));
            let minusExprs = _.map(minuses, (p) => 'not' + render(p, new RenderContext(option, hasFieldInExr)));
            result += _.join(_.concat(plusExprs, minusExprs), ' AND ');
        }
    }
    else {
        result += render(tree, new RenderContext(option, hasFieldInExr));
    }
    return result;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHEyeHEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJscTJ4cS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVFQUFrRTtBQUNsRSw0QkFBNEI7QUE2QjVCLE1BQU0sbUJBQW1CLEdBQW1CO0lBQzFDLFlBQVksRUFBRSxHQUFHO0lBQ2pCLGtCQUFrQixFQUFFLElBQUk7Q0FDekIsQ0FBQTtBQVFBLENBQUM7QUFNRCxDQUFDO0FBbUJGO0lBR0UsWUFBWSxNQUFxQixFQUFFLFFBQWlCO1FBQ2xELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzNCLENBQUM7Q0FDRjtBQUVELE1BQU0sV0FBVyxHQUFHLENBQUMsSUFBYyxFQUFFLEdBQWtCO0lBQ3JELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLElBQUksU0FBa0IsQ0FBQztRQUN2QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQztZQUNyQixTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFDL0IsSUFBSTtZQUNGLFNBQVMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztRQUN0QyxNQUFNLENBQUMsR0FBRyxTQUFTLGlCQUFpQixDQUFDO0lBQ3ZDLENBQUM7SUFBQyxJQUFJO1FBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztBQUNuQixDQUFDLENBQUE7QUFFRCxNQUFNLGVBQWUsR0FBRyxDQUFDLElBQVk7SUFDbkMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7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