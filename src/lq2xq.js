"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const luceneQueryParser_1 = require("./luceneQuery/luceneQueryParser");
const _ = require("lodash");
const DefaultRenderOption = {
    defaultField: '.',
    termPhraseModifier: null
};
class RenderContext {
    constructor(option, hasField) {
        this.option = option;
        this.hasField = hasField;
    }
}
const renderField = (term, ctx) => {
    if (ctx.hasField) {
        let fieldname;
        if (term.field != null)
            fieldname = term.field.field;
        else
            fieldname = ctx.option.defaultField;
        return `${fieldname} contains text `;
    }
    else
        return "";
};
const convertWildCard = (term) => {
    if (/[*?]/.test(term)) {
        return term.replace(/([*])/g, ".*").replace(/[?]/g, ".");
    }
    else
        return null;
};
const renderTerm = (term, ctx) => __awaiter(this, void 0, void 0, function* () {
    if (ctx.option.termPhraseExpander) {
        let expr = _(yield ctx.option.termPhraseExpander(term.term, term.field ? term.field.field : null, false, term.prefix))
            .map((newTerm) => renderTermClause(_.assign({}, term, { term: newTerm }), ctx))
            .join(' ftor ');
        return `(${renderField(term, ctx)}${expr})`;
    }
    else
        return `(${renderField(term, ctx)}${renderTermClause(term, ctx)})`;
});
const renderTermClause = (term, ctx) => {
    let result;
    let wildCardTerm = convertWildCard(term.term);
    if (wildCardTerm != null)
        result = `"${wildCardTerm}" using wildcards`;
    else
        result = `"${term.term}"`;
    if (term.boost != null)
        result += ` weight {${term.boost}}`;
    if (term.similarity != null) {
        if (ctx.option.similarityConverter == null)
            throw new Error("Similarity is not supported");
        else
            result += ` ${ctx.option.similarityConverter(term.similarity)}`;
    }
    if (ctx.option.termPhraseModifier)
        result += ` ${ctx.option.termPhraseModifier}`;
    return result;
};
const renderPhrase = (phrase, ctx) => __awaiter(this, void 0, void 0, function* () {
    if (ctx.option.termPhraseExpander) {
        let expr = _(yield ctx.option.termPhraseExpander(phrase.term, phrase.field ? phrase.field.field : null, false, phrase.prefix))
            .map((newPhrase) => renderPhraseClause(_.assign({}, phrase, { term: newPhrase }), ctx))
            .join(' ftor ');
        return `(${renderField(phrase, ctx)}${expr})`;
    }
    else
        return `(${renderField(phrase, ctx)}${renderPhraseClause(phrase, ctx)})`;
});
const renderPhraseClause = (phrase, ctx) => {
    let result = `"${phrase.term}"`;
    if (phrase.boost != null)
        result += ` weight {${phrase.boost}}`;
    if (phrase.proximity != null)
        result += ` distance at most ${phrase.proximity} words`;
    if (ctx.option.termPhraseModifier)
        result += ` ${ctx.option.termPhraseModifier}`;
    return result;
};
const renderOperator = (op, ctx) => {
    switch (op) {
        case 'AND': return ctx.hasField ? 'AND' : 'ftand';
        case 'OR': return ctx.hasField ? 'OR' : 'ftor';
        default: throw new Error(`Operator ${op} is not recognized.`);
    }
};
const renderRange = (range, ctx) => {
    if (range.field == null)
        throw new Error("Must specify field on range query");
    let field = range.field.field;
    let ops = range.inclusive ? ['>=', '<='] : ['>', '<'];
    return `(${field}${ops[0]}"${range.term_min}" AND ${field}${ops[1]}"${range.term_max}")`;
};
const renderExpr = (expr, ctx) => __awaiter(this, void 0, void 0, function* () {
    if (expr.operator == 'NOT') {
        throw new Error("Lucene query's NOT operator is broken, see https://stackoverflow.com/questions/17969461/" +
            "not-operator-doesnt-work-in-query-lucene, use - modifier instead");
    }
    return `(${yield render(expr.left, ctx)} ${renderOperator(expr.operator, ctx)} ${yield render(expr.right, ctx)})`;
});
const isSameField = (t1, t2) => {
    if (t1.field === t2.field)
        return true; // both null
    else if (t1.field && t2.field)
        return t1.field.field == t2.field.field;
    else
        return false;
};
const isTerm = (node) => _.has(node, "similarity");
const isPhrase = (node) => _.has(node, "proximity");
const isTermOrPhrase = (node) => isTerm(node) || isPhrase(node);
const isRange = (node) => _.has(node, 'inclusive');
const hasOperator = (node) => (true && node.operator);
const hasLeft = (node) => true && node.left;
const render = (tree, ctx) => __awaiter(this, void 0, void 0, function* () {
    if (tree === undefined)
        return '';
    else if (isTerm(tree))
        return yield renderTerm(tree, ctx);
    else if (isPhrase(tree))
        return yield renderPhrase(tree, ctx);
    else if (isRange(tree))
        return renderRange(tree, ctx);
    else if (hasOperator(tree))
        return yield renderExpr(tree, ctx); // binary or unary expression
    else if (hasLeft(tree))
        return yield render(tree.left, ctx); // an operator-less (single term) expression
    else
        throw new Error(`${JSON.stringify(tree, null, '  ')} can't be rendered`);
});
// scan tree recursively to see if any field exists
const hasField = (tree) => {
    if (tree === undefined)
        return false;
    else
        return tree.field != null || hasField(tree.left) || hasField(tree.right);
};
const pressField = (tree) => {
    if (tree) {
        if (tree.field) {
            if (tree.left)
                tree.left.field = tree.field;
            if (tree.right)
                tree.right.field = tree.field;
        }
        if (tree.left)
            pressField(tree.left);
        if (tree.right)
            pressField(tree.right);
    }
};
const hasAnd = (tree) => {
    if (tree === undefined)
        return false;
    else
        return tree.operator === 'AND' || hasAnd(tree.left) || hasAnd(tree.right);
};
const hasPrefix = (tree) => {
    if (tree === undefined)
        return false;
    else
        return (tree.prefix) || hasPrefix(tree.left) || hasPrefix(tree.right);
};
const reconstructClauses = (tree, musts, mustnots) => {
    if (tree) {
        if (tree.prefix) {
            if (tree.prefix == '+')
                musts.push(tree);
            else if (tree.prefix == '-')
                mustnots.push(tree);
        }
        else if (isRange(tree)) {
            musts.push(tree);
        }
        reconstructClauses(tree.left, musts, mustnots);
        reconstructClauses(tree.right, musts, mustnots);
    }
};
/**
 *
 * lucene query to xquery translater
 *
 * @param {string} lq
 * @returns {string}
 *
 */
exports.lq2xq = (lq, option) => __awaiter(this, void 0, void 0, function* () {
    let tree = luceneQueryParser_1.luceneQueryParser.parse(lq);
    if (!option)
        option = DefaultRenderOption;
    else
        option = _.assign({}, DefaultRenderOption, option); // ensure default values are filled
    let hasFieldInExr = hasField(tree);
    if (hasFieldInExr)
        pressField(tree); // ensure field is set in every Term or Phrase, instead of Expression
    let result = '';
    if (!hasFieldInExr)
        result += `${option.defaultField} contains text `;
    if (hasPrefix(tree)) {
        // if there are + or -, then we ignore all logical operators such as AND OR NOT, they are incompatible
        let pluses = [], minuses = [];
        reconstructClauses(tree, pluses, minuses);
        if (!hasFieldInExr) {
            let plusExprs = yield Promise.all(_.map(pluses, (p) => render(p, new RenderContext(option, hasFieldInExr))));
            let minusExprs = yield Promise.all(_.map(minuses, (p) => render(p, new RenderContext(option, hasFieldInExr))));
            minusExprs = _.map(minusExprs, (e) => 'ftnot ' + e);
            result += _.join(_.concat(plusExprs, minusExprs), ' ftand ');
        }
        else {
            //console.log(JSON.stringify(tree, null, '  '));
            let plusExprs = yield Promise.all(_.map(pluses, (p) => render(p, new RenderContext(option, hasFieldInExr))));
            let minusExprs = yield Promise.all(_.map(minuses, (p) => render(p, new RenderContext(option, hasFieldInExr))));
            minusExprs = _.map(minusExprs, (e) => 'not' + e);
            result += _.join(_.concat(plusExprs, minusExprs), ' AND ');
        }
    }
    else {
        result += yield render(tree, new RenderContext(option, hasFieldInExr));
    }
    return result;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHEyeHEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJscTJ4cS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsdUVBQWtFO0FBQ2xFLDRCQUE0QjtBQTZCNUIsTUFBTSxtQkFBbUIsR0FBbUI7SUFDMUMsWUFBWSxFQUFFLEdBQUc7SUFDakIsa0JBQWtCLEVBQUUsSUFBSTtDQUN6QixDQUFDO0FBbUNGO0lBR0UsWUFBWSxNQUFxQixFQUFFLFFBQWlCO1FBQ2xELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzNCLENBQUM7Q0FDRjtBQUVELE1BQU0sV0FBVyxHQUFHLENBQUMsSUFBYyxFQUFFLEdBQWtCO0lBQ3JELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLElBQUksU0FBa0IsQ0FBQztRQUN2QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQztZQUNyQixTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFDL0IsSUFBSTtZQUNGLFNBQVMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztRQUN0QyxNQUFNLENBQUMsR0FBRyxTQUFTLGlCQUFpQixDQUFDO0lBQ3ZDLENBQUM7SUFBQyxJQUFJO1FBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztBQUNuQixDQUFDLENBQUM7QUFFRixNQUFNLGVBQWUsR0FBRyxDQUFDLElBQVk7SUFDbkMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDM0QsQ0FBQztJ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LEdBQUcsQ0FBQyxJQUFJLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQztBQUNwSCxDQUFDLENBQUEsQ0FBQztBQUVGLE1BQU0sV0FBVyxHQUFHLENBQUMsRUFBWSxFQUFFLEVBQVk7SUFDN0MsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssS0FBSyxFQUFFLENBQUMsS0FBSyxDQUFDO1FBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFHLFlBQVk7SUFDdEQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQztRQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztJQUN2RSxJQUFJO1FBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztBQUNwQixDQUFDLENBQUM7QUFDRixNQUFNLE1BQU0sR0FBRyxDQUFDLElBQVMsS0FBZSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztBQUNsRSxNQUFNLFFBQVEsR0FBRyxDQUFDLElBQVMsS0FBZSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQztBQUNuRSxNQUFNLGNBQWMsR0FBRyxDQUFDLElBQVMsS0FBZSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQy9FLE1BQU0sT0FBTyxHQUFHLENBQUMsSUFBUyxLQUFlLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQ2xFLE1BQU0sV0FBVyxHQUFHLENBQUMsSUFBUyxLQUFlLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNyRSxNQUFNLE9BQU8sR0FBRyxDQUFDLElBQVMsS0FBZSxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQztBQUUzRCxNQUFNLE1BQU0sR0FBRyxDQUFPLElBQVEsRUFBRSxHQUFrQjtJQUNoRCxFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDO1FBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztJQUNsQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQUMsTUFBTSxDQUFDLE1BQU0sVUFBVSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMxRCxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQUMsTUFBTSxDQUFDLE1BQU0sWUFBWSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM5RCxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDdEQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUFDLE1BQU0sQ0FBQyxNQUFNLFVBQVUsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyw2QkFBNkI7SUFDN0YsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUFDLE1BQU0sQ0FBQyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUksNENBQTRDO0lBQzVHLElBQUk7UUFBQyxNQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQ2hGLENBQUMsQ0FBQSxDQUFDO0FBRUYsbURBQW1EO0FBQ25ELE1BQU0sUUFBUSxHQUFHLENBQUMsSUFBUTtJQUN4QixFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDO1FBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztJQUNyQyxJQUFJO1FBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNoRixDQUFDLENBQUM7QUFDRixNQUFNLFVBQVUsR0FBRyxDQUFDLElBQVE7SUFDMUIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNULEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ2YsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQzVDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7Z0JBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNoRCxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQztBQUNILENBQUMsQ0FBQztBQUNGLE1BQU0sTUFBTSxHQUFHLENBQUMsSUFBUztJQUN2QixFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDO1FBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztJQUNyQyxJQUFJO1FBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEtBQUssS0FBSyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FB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